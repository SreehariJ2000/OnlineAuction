<!-- your_extended_template.html -->
{% extends "sellor/sellor_base.html" %}

{% block style %}
  {{ block.super }}
  <style>
    /* Add your custom styles here */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    th, td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    th {
        background-color: #f2f2f2;
    }

    tr:hover {
        background-color: #f5f5f5;
    }

    .reauction-btn {
        background-color: #007bff;
        color: #ffffff;
        border: none;
        padding: 8px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .reauction-btn:hover {
        background-color: #0056b3;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0, 0, 0);
        background-color: rgba(0, 0, 0, 0.4);
        padding-top: 60px;
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
    }
  </style>
{% endblock style %}

{% block body %}
  <h1>Rejected Products for Reauction</h1>
  <table>
    <thead>
      <tr>
        <th>Product Name</th>
        <th>Product Image</th>
        <th>Auction Started</th>
        <th>Auction End</th>
        <th>About</th>
        <!-- Add more header columns as needed -->
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for product in rejected_products %}
        <tr>
          <td>{{ product.product.product_name }}</td>
          <td>
            <img src="{{ product.product.image1.url }}" height="250px" width="100px" class="card-img" alt="{{ product.product_name }}">
          </td>
          <td>{{ product.product.auction_start_datetime }}</td>
          <td>{{ product.product.auction_end_datetime }}</td>
          <td>{{ product.product.about_product }}</td>
          <td>
            <button class="reauction-btn" onclick="openModal({{ product.product.id }})">Reauction</button>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Modal -->
  <div id="reauctionModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2>Reauction Product</h2>
      <input type="hidden" id="productIdInput" name="productIdInput">
      <label for="start-date">Auction Start Date:</label>
      <input type="datetime-local" id="startDateTime" name="startDateTime" required>
      <span class="error-message" id="startError"></span>
      <br>
      <label for="end-date">Auction End Date:</label>
      <input type="datetime-local" id="endDateTime" name="endDateTime" required>
      <span class="error-message" id="endError"></span>
      <br>
      <button onclick="submitReauction()">Reauction</button>
    </div>
  </div>

  <script>
    function openModal(productId) {
      document.getElementById('reauctionModal').style.display = 'block';
      document.getElementById('productIdInput').value = productId;
    }

    function closeModal() {
      document.getElementById('reauctionModal').style.display = 'none';
    }

    function submitReauction() {
      const startDateTime = document.getElementById('startDateTime');
      const endDateTime = document.getElementById('endDateTime');
      const startError = document.getElementById('startError');
      const endError = document.getElementById('endError');
      const productId = document.getElementById('productIdInput').value; // Get the product ID

      if (validateStartDate(startDateTime, startError) && validateEndDate(startDateTime, endDateTime, endError)) {
        sendAuctionDetailsToBackend(productId);
        closeModal();
      }
    }

    // Function to validate if the start date and time is at least 5 minutes from now and not greater than six months from now
    function validateStartDate(startDateTime, errorElement) {
      const inputDate = new Date(startDateTime.value);
      const currentDate = new Date();
      const sixMonthsLater = new Date();
      sixMonthsLater.setMonth(currentDate.getMonth() + 6); // 6 months from now
      currentDate.setMinutes(currentDate.getMinutes() + 5); // 5 minutes from now

      if (inputDate <= currentDate) {
        errorElement.textContent = 'Start date and time must be at least 5 minutes from now.';
        errorElement.style.color = 'red'; // Set error message color to red
        return false;
      } else if (inputDate > sixMonthsLater) {
        errorElement.textContent = 'Start date must not be greater than six months from now.';
        errorElement.style.color = 'red'; // Set error message color to red
        return false;
      } else {
        errorElement.textContent = '';
        return true;
      }
    }

    // Function to validate if the end date and time is greater than the start time
    function validateEndDate(startDateTime, endDateTime, errorElement) {
      const startDate = new Date(startDateTime.value);
      const endDate = new Date(endDateTime.value);
      const currentDate = new Date();

      if (startDate >= endDate) {
        errorElement.textContent = 'End date and time must be greater than the start time.';
        errorElement.style.color = 'red'; // Set error message color to red
        return false;
      } else if (endDate <= currentDate) {
        errorElement.textContent = 'End date and time must be in the future.';
        errorElement.style.color = 'red'; // Set error message color to red
        return false;
      } else {
        errorElement.textContent = '';
        return true;
      }
    }

    // Add event listeners for real-time validation
    document.getElementById('startDateTime').addEventListener('input', function () {
      validateStartDate(this, document.getElementById('startError'));
    });

    document.getElementById('endDateTime').addEventListener('input', function () {
      validateEndDate(document.getElementById('startDateTime'), this, document.getElementById('endError'));
    });

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    

    function sendAuctionDetailsToBackend(productId) {
      const startDateTime = document.getElementById('startDateTime');
      const endDateTime = document.getElementById('endDateTime');
      const startDateValue = startDateTime.value;
      const endDateValue = endDateTime.value;
      console.log("pidd", productId);
      console.log("dtart date", startDateValue);
    
      // Use AJAX to send data to the Django backend
      const csrfToken = getCookie('csrftoken');
      if (csrfToken) {
        console.log('CSRF Token:', csrfToken);
    
        // Create a FormData object and append the data
        const formData = new FormData();
        formData.append('product_id', productId);
        formData.append('start_date', startDateValue);
        formData.append('end_date', endDateValue);
        formData.append('csrfmiddlewaretoken', csrfToken);
    
        // Make the AJAX request with the FormData
        fetch('http://127.0.0.1:8000/start_reauction/', {
          method: 'POST',
          body: formData,
        })
          .then(response => response.json())
          .then(data => {
            // Handle the response from the backend if needed
            console.log('Response from backend:', data);
          })
          .catch(error => {
            console.error('Error:', error);
          });
      } else {
        console.error('CSRF Token not found');
      }
    }
    
  </script>
{% endblock body %}
